rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isAdmin() {
      return request.auth.token.role == 'admin';
    }

    function isMemberOfAccount(accountId) {
      return request.auth.token.accountId == accountId;
    }
    
    // User profile can be read by the user themselves or by an admin of the same account
    match /users/{userId} {
      allow read: if request.auth.uid == userId || (isAdmin() && isMemberOfAccount(resource.data.accountId));
      allow update: if request.auth.uid == userId; // Users can update their own profile
      // Create and delete are handled by server-side actions
      allow create, delete: if false; 
      allow list: if false; // List operations on root users collection are disallowed for clients
    }

    // Rules for all subcollections under a specific account
    match /accounts/{accountId}/{document=**} {
      // Any authenticated member of the account can read or list documents
      allow read, list: if isMemberOfAccount(accountId);
      
      // Only admins of the account can write documents
      allow write: if isAdmin() && isMemberOfAccount(accountId);
    }
  }
}


rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    function isAdmin() {
      return request.auth.token.role == 'admin';
    }

    function isAccountMember(accountId) {
      return request.auth.token.accountId == accountId;
    }

    match /accounts/{accountId} {
      allow read, update, delete: if isAccountMember(accountId) && isAdmin();
      // Allow a user to create an account for themselves, where their UID becomes the accountId.
      allow create: if request.auth.uid == accountId;

      // Sub-collections
      match /{collection}/{docId} {
        allow read, list, update, delete: if isAccountMember(accountId) && isAdmin();
        allow create: if isAccountMember(accountId) && isAdmin();
      }
    }

    match /users/{userId} {
      // Allow a user to create their own user document.
      allow create: if request.auth.uid == userId;
      // Allow a user to read their own document.
      allow get: if request.auth.uid == userId;
      // Allow an admin to read any user document within their own account.
      allow get: if isAdmin() && isAccountMember(resource.data.accountId);
      // Allow admins to update users in their account.
      allow update: if isAdmin() && isAccountMember(request.auth.token.accountId);
      // Allow admins to list users in their account.
      allow list: if isAdmin() && request.query.filters.size() == 1 && request.query.filters.accountId == request.auth.token.accountId;
    }
  }
}

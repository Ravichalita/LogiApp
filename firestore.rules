rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    function isUserAuthenticated() {
      return request.auth != null;
    }

    function isUserAccountMember(accountId) {
      return isUserAuthenticated() && request.auth.token.accountId == accountId;
    }

    function isUserAdmin(accountId) {
      return isUserAccountMember(accountId) && request.auth.token.role == 'admin';
    }

    match /accounts/{accountId} {
      allow read: if isUserAccountMember(accountId);
      allow write: if isUserAdmin(accountId);

      // Clients
      match /clients/{clientId} {
        allow read, write: if isUserAccountMember(accountId);
        allow list: if isUserAccountMember(accountId) && request.query.filters.size() == 1 && request.query.filters[0].field.pathString == "accountId" && request.query.filters[0].value == accountId;
      }

      // Dumpsters
      match /dumpsters/{dumpsterId} {
        allow read, write: if isUserAccountMember(accountId);
        allow list: if isUserAccountMember(accountId) && request.query.filters.size() == 1 && request.query.filters[0].field.pathString == "accountId" && request.query.filters[0].value == accountId;
      }
      
      // Rentals
      match /rentals/{rentalId} {
        allow read, write: if isUserAccountMember(accountId);
        allow list: if isUserAccountMember(accountId) && request.query.filters.size() == 1 && request.query.filters[0].field.pathString == "accountId" && request.query.filters[0].value == accountId;
      }

      // Completed Rentals
      match /completed_rentals/{rentalId} {
        allow read, write: if isUserAccountMember(accountId);
        allow list: if isUserAccountMember(accountId) && request.query.filters.size() == 1 && request.query.filters[0].field.pathString == "accountId" && request.query.filters[0].value == accountId;
      }
    }

    // User documents can be read by the user themselves
    match /users/{userId} {
      allow get: if isUserAuthenticated() && request.auth.uid == userId;
      allow create: if isUserAuthenticated();
      allow update, delete: if isUserAuthenticated() && request.auth.uid == userId;
      // Admins can list all users within their account
      allow list: if isUserAuthenticated() 
                  && request.auth.token.role == 'admin'
                  && request.query.filters.size() == 1 
                  && request.query.filters[0].field.pathString == "accountId" 
                  && request.query.filters[0].value == request.auth.token.accountId;
    }
  }
}
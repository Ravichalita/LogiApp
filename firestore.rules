rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions to make rules more readable
    function isAuth() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuth() && request.auth.uid == userId;
    }
    
    function getUserData(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }

    // Rules for the users collection
    match /users/{userId} {
      // ANY authenticated user can create their OWN user document.
      allow create: if isAuth();

      // A user can ONLY read THEIR OWN document.
      allow get: if isOwner(userId);
      
      // A user can list other users ONLY IF they belong to the same account.
      // The query from the client MUST include `where('accountId', '==', currentUser.accountId)`
      allow list: if isAuth() && request.query.where.accountId == getUserData(request.auth.uid).accountId;

      // A user can update their own name.
      // An admin can update other users' role or status within the same account.
      allow update: if isOwner(userId) && request.resource.data.keys().hasOnly(['name']) ||
                     isAuth() && getUserData(request.auth.uid).role == 'admin' &&
                     getUserData(request.auth.uid).accountId == getUserData(userId).accountId;
      
      // An admin can delete a user from their account. The user being deleted cannot be the admin themselves.
      allow delete: if isAuth() && getUserData(request.auth.uid).role == 'admin' && 
                       request.auth.uid != userId &&
                       getUserData(request.auth.uid).accountId == getUserData(userId).accountId;
    }

    // Rules for all subcollections within an account
    match /accounts/{accountId}/{document=**} {
      // Allow read/write access only if the user's accountId (from their user doc)
      // matches the accountId in the path.
      allow read, write: if isAuth() && getUserData(request.auth.uid).accountId == accountId;
    }
  }
}

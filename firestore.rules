rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions to reduce duplication
    function isOwner(accId) {
      return request.auth.token.accountId == accId;
    }
    function isAdmin() {
      return request.auth.token.role == 'admin';
    }
    function isMember(accId) {
      return request.auth.token.accountId == accId;
    }

    // Accounts can only be read by their members. Creation is handled server-side.
    match /accounts/{accountId} {
      allow read: if isMember(accountId);
      allow write: if false; // Disallow all client-side writes
    }

    // A user can read their own document. Admins can list all users in their account.
    match /users/{userId} {
      allow get: if isMember(resource.data.accountId);
      allow list: if isAdmin() && request.query.resource.data.accountId == request.auth.token.accountId;
      allow create, update, delete: if isAdmin();
    }

    // Rules for all subcollections under an account
    match /accounts/{accountId}/{collection}/{docId} {
      // Only members of the account can access these documents
      allow get: if isMember(accountId);
      
      // Allow list operations only if they are querying for their own account's data
      allow list: if isMember(accountId) && request.query.resource.data.accountId == request.auth.token.accountId;

      // Only admins of the account can write data
      allow create, update, delete: if isAdmin() && isOwner(accountId);
    }
  }
}

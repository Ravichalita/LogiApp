rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // As informações da conta do usuário (incluindo o ID da conta) são armazenadas
    // como custom claims no token de autenticação do Firebase.
    // Isso evita a necessidade de uma busca extra no banco de dados (get()) dentro das regras,
    // que é ineficiente e muitas vezes não permitido em regras de listagem de coleção.
    function getAccountId() {
      return request.auth.token.accountId;
    }

    function isAuth() {
      return request.auth != null;
    }
    
    // Verifica se o usuário autenticado pertence à conta que está tentando acessar.
    function userIsInAccount(accountId) {
      return isAuth() && getAccountId() == accountId;
    }
    
    // Verifica se o usuário autenticado tem a função de 'admin' na sua conta.
    function isAdmin() {
      return isAuth() && request.auth.token.role == 'admin';
    }

    match /accounts/{accountId} {
      // Regra geral para todas as subcoleções dentro de uma conta (clients, dumpsters, rentals, etc.)
      match /{documents=**} {
        allow read, write: if userIsInAccount(accountId);
      }
    }

    match /users/{userId} {
      allow get: if isAuth() && 
                    (request.auth.uid == userId || 
                    get(/databases/$(database)/documents/users/$(userId)).data.accountId == getAccountId());
      
      // Permite a listagem de usuários somente se a consulta for filtrada pelo accountId do usuário solicitante.
      // Isso impede que um usuário liste usuários de outras contas.
      allow list: if isAuth() && request.query.where.get("accountId")[2] == getAccountId();
      
      // Permite a criação por qualquer pessoa (signup). A lógica de associação à conta é tratada no backend.
      allow create: if true;
      
      // Permite a atualização apenas se o usuário for um administrador da mesma conta.
      allow update: if isAuth() && isAdmin() && get(/databases/$(database)/documents/users/$(userId)).data.accountId == getAccountId();

      // Permite a exclusão apenas por administradores da mesma conta.
      allow delete: if isAuth() && isAdmin() && get(/databases/$(database)/documents/users/$(userId)).data.accountId == getAccountId();
    }
  }
}
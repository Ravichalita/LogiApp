rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isUserAccountOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function isAccountAdmin(accountId) {
      return isSignedIn() && getUserData().role == 'admin' && getUserData().accountId == accountId;
    }

    function isAccountMember(accountId) {
      return isSignedIn() && getUserData().accountId == accountId;
    }

    // Matches
    match /users/{userId} {
      allow get: if isUserAccountOwner(userId) || isAccountAdmin(getUserData().accountId);
      allow list: if isAccountAdmin(getUserData().accountId);
      allow update: if isUserAccountOwner(userId);
      allow create, delete: if false; // Disallow client-side creation/deletion
    }
    
    match /accounts/{accountId} {
       allow get: if isAccountMember(accountId);
       // Allow members to see who is in their own account.
       match /team/{userId} {
         allow read: if isAccountMember(accountId);
         allow write: if isAccountAdmin(accountId); // Only admins can change team members
       }
       
       // Data collections within an account
       match /clients/{clientId} {
          allow read, list: if isAccountMember(accountId);
          allow write: if isAccountAdmin(accountId);
       }
       match /dumpsters/{dumpsterId} {
          allow read, list: if isAccountMember(accountId);
          allow write: if isAccountAdmin(accountId);
       }
       match /rentals/{rentalId} {
          allow read, list: if isAccountMember(accountId);
          allow write: if isAccountAdmin(accountId);
       }
       match /completed_rentals/{rentalId} {
          allow read, list: if isAccountMember(accountId);
          allow write: if isAccountAdmin(accountId);
       }
    }
  }
}
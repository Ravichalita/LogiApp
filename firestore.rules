rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if the authenticated user's token has a specific accountId.
    // This is the core of the multi-tenant security.
    function userIsInAccount(accountId) {
      return request.auth != null && request.auth.token.accountId == accountId;
    }
    
    // Helper function to check if the authenticated user is an admin for their account.
    function isAccountAdmin() {
      return request.auth != null && request.auth.token.role == 'admin';
    }

    // Rules for all collections under an account (clients, dumpsters, rentals, etc.)
    // Access is granted if the user's token contains the correct accountId.
    match /accounts/{accountId}/{documents=**} {
      allow read, write: if userIsInAccount(accountId);
    }

    // Rules for the top-level users collection
    match /users/{userId} {
      // Allow a user to read their own document.
      // Allow any user to read another user's document IF they are in the same account.
      allow get: if userIsInAccount(resource.data.accountId);
      
      // Allow a user to list documents from the 'users' collection ONLY IF
      // the query explicitly filters for their own accountId. This prevents
      // a user from listing users from other accounts.
      // This is the key rule that fixes the "team members not appearing" issue.
      allow list: if userIsInAccount(request.query.where.accountId);
      
      // Allow a user to update another user's document IF:
      // 1. They are in the same account.
      // 2. They have the 'admin' role in their token.
      allow update: if userIsInAccount(resource.data.accountId) && isAccountAdmin();

      // Allow anyone to create a user document, as this is handled by a server-side action (`signupAction`)
      // which performs its own validation before creating the user.
      allow create: if request.auth != null;
    }
  }
}

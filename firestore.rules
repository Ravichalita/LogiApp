rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper functions
    function isUserAuthenticated() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isUserInAccount(accountId) {
      return isUserAuthenticated() && getUserData().accountId == accountId;
    }

    function isUserAdmin(accountId) {
      return isUserInAccount(accountId) && getUserData().role == 'admin';
    }

    // Match all collections under a specific account
    match /accounts/{accountId}/{document=**} {
      allow read, write: if isUserInAccount(accountId);
    }
    
    // Rules for the 'users' collection
    match /users/{userId} {
      // Allow a user to read another user's document if they are in the same account
      allow get: if isUserAuthenticated() && getUserData().accountId == get(/databases/$(database)/documents/users/$(userId)).data.accountId;

      // Allow a user to list users only if they are querying by their own accountId
      allow list: if isUserAuthenticated() && request.query.where.get("accountId") == getUserData().accountId;

      // Allow user to create their own document (signup) - handled by actions
      allow create: if true; 
      
      // Allow an admin to update a user's role/status in the same account
      allow update: if isUserAdmin(getUserData().accountId) && getUserData().accountId == resource.data.accountId;
      
      // Allow an admin to delete a user from the same account
      allow delete: if isUserAdmin(getUserData().accountId);
    }
  }
}

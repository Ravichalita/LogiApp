
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user belongs to a specific account
    function isAccountMember(accountId) {
      return request.auth.token.accountId == accountId;
    }

    // Lock down accounts to only be readable/writable by their members
    match /accounts/{accountId} {
      allow read, write: if isAccountMember(accountId);
      
      // Any member of the account can read/write clients, dumpsters etc.
      // The specific UI/API logic will control who can do what (e.g. admin vs viewer)
      match /{collection}/{docId} {
        allow read, write: if isAccountMember(accountId);
      }
    }

    // Users can only read their own document
    match /users/{userId} {
      allow get: if request.auth.uid == userId;
      // Creation is handled by server-side logic (ensureUserDocument)
      allow create, update, delete: if false; 
    }
    
    // This rule allows collection group queries on 'rentals'.
    // It's secure because it checks if the document's accountId matches the user's claim.
    match /{path=**}/rentals/{rentalId} {
      allow read: if isAccountMember(resource.data.accountId);
    }
  }
}

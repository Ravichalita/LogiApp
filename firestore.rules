rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function isAuth() {
      return request.auth != null;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function isUserInAccount(accountId) {
      return isAuth() && getUserData().accountId == accountId;
    }
    
    function isUserRole(role) {
       return isAuth() && getUserData().role == role;
    }

    // Rules for the 'users' collection
    match /users/{userId} {
      // Allow a user to get another user's document if they are in the same account
      allow get: if isAuth() && getUserData().accountId == resource.data.accountId;

      // Allow a user to list users only if the query is constrained to their own account
      allow list: if isAuth() && request.query.get('where')[0][2] == getUserData().accountId;

      // Allow a user to update another user's document if they are an admin in the same account
      allow update: if isUserInAccount(resource.data.accountId) && isUserRole('admin');

      // Allow anyone to create a user document (signup)
      allow create: if true;
      
      // Do not allow deletion of user documents through client-side requests for safety.
      // Deletion is handled by a server-side action.
      allow delete: if false;
    }

    // Rules for all subcollections within an account
    match /accounts/{accountId}/{documents=**} {
      // Allow read/write access only to users who belong to this account
      allow read, write: if isUserInAccount(accountId);
    }
  }
}

rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isAccountMember(accountId) {
      // Check if the user is authenticated and if their token's accountId matches the document's accountId.
      return request.auth != null && request.auth.token.accountId == accountId;
    }

    match /accounts/{accountId} {
      // Only admins of the account can manage account-level details.
      // Creation is handled by the user signup logic.
      allow read, update, delete: if isAccountMember(accountId) && request.auth.token.role == 'admin';
      allow create: if request.auth.uid == accountId; // A user can create their own account document.
    }

    match /users/{userId} {
      // A user can always get their own document.
      // An admin can get any user document within their account.
      allow get: if request.auth.uid == userId || (isAccountMember(resource.data.accountId) && request.auth.token.role == 'admin');

      // A user can create their own user document during signup.
      allow create: if request.auth.uid == userId;

      // A user can update their own profile, or an admin can update any user in their account.
      allow update: if request.auth.uid == userId || (isAccountMember(resource.data.accountId) && request.auth.token.role == 'admin');

      // Only an admin can remove a user from an account. A user can't delete themselves this way.
      allow delete: if isAccountMember(resource.data.accountId) && request.auth.token.role == 'admin';
    }

    // Rules for all subcollections within an account (clients, dumpsters, rentals, etc.)
    match /accounts/{accountId}/{collection}/{documentId} {
      // Any member of the account can read the data.
      allow read: if isAccountMember(accountId);
      
      // Only admins can write (create, update, delete) data.
      // This will be expanded later to use granular permissions.
      allow write: if isAccountMember(accountId) && request.auth.token.role == 'admin';
    }
  }
}

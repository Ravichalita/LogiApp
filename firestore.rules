rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper function to check if the user is authenticated
    function isAuth() {
      return request.auth != null;
    }

    // Helper function to check if the authenticated user belongs to a specific account
    function isUserInAccount(accountId) {
      return isAuth() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.accountId == accountId;
    }
    
    // Helper function to check if the authenticated user is an admin of a specific account
    function isUserAdmin(accountId) {
        return isUserInAccount(accountId) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Matches any document in any subcollection of an account
    match /accounts/{accountId}/{document=**} {
      allow read, write: if isUserInAccount(accountId);
    }

    match /users/{userId} {
      // Allow a user to read their own document or if they are in the same account
      allow get: if isAuth() && 
                    (request.auth.uid == userId || 
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.accountId == resource.data.accountId);
      
      // Allow a user to list users only if they are querying by their own accountId
      allow list: if isAuth() && request.query.where.get('accountId') == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.accountId;

      // Allow a user to update their own document, or an admin to update any user in the same account
      allow update: if isAuth() && 
                     (request.auth.uid == userId || 
                      (isUserAdmin(resource.data.accountId) && request.auth.uid != userId));

      // Disallow client-side creation and deletion of user documents
      allow create, delete: if false;
    }
  }
}
